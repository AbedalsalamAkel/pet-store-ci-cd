name: assignment4

on:
  push:

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      petstore_built: ${{ steps.flags.outputs.petstore_built }}
      petorder_built: ${{ steps.flags.outputs.petorder_built }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Init log
        run: |
          echo "date -Iminutes: $(date -Iminutes)" > log.txt
          echo "submitters: Abedalsalam Akel" >> log.txt

      - name: Build images (continue even if one fails)
        id: build_images
        continue-on-error: true
        run: |
          mkdir -p images

          if docker build -t petstore:assn4 ./petstore ; then
            echo "image petstore successfully built" >> log.txt
            docker save petstore:assn4 -o images/petstore.tar
            echo "PETSTORE_BUILT=true" >> $GITHUB_ENV
          else
            echo "image petstore not able to be built" >> log.txt
            echo "PETSTORE_BUILT=false" >> $GITHUB_ENV
          fi

          if docker build -t pet-order:assn4 ./pet-order ; then
            echo "image pet-order successfully built" >> log.txt
            docker save pet-order:assn4 -o images/pet-order.tar
            echo "PETORDER_BUILT=true" >> $GITHUB_ENV
          else
            echo "image pet-order not able to be built" >> log.txt
            echo "PETORDER_BUILT=false" >> $GITHUB_ENV
          fi

      - name: Export flags as job outputs
        id: flags
        run: |
          echo "petstore_built=${PETSTORE_BUILT}" >> $GITHUB_OUTPUT
          echo "petorder_built=${PETORDER_BUILT}" >> $GITHUB_OUTPUT

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            images/*.tar
            log.txt

  test:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          path: .

      - run: |
          if [ -f images/petstore.tar ]; then docker load -i images/petstore.tar; fi
          if [ -f images/pet-order.tar ]; then docker load -i images/pet-order.tar; fi

      - run: docker network create assn4net || true

      - run: |
          docker rm -f mongo_order || true
          docker run -d --name mongo_order --network assn4net mongo:7

      - id: start
        continue-on-error: true
        run: |
          docker rm -f petstore1 petstore2 pet-order || true

          docker run -d --name petstore1 --network assn4net -p 5001:5001 -e PORT=5001 petstore:assn4
          docker run -d --name petstore2 --network assn4net -p 5002:5001 -e PORT=5001 petstore:assn4
          docker run -d --name pet-order --network assn4net -p 5003:5001 \
            -e PORT=5001 \
            -e MONGO_URL=mongodb://mongo_order:27017 \
            pet-order:assn4

      - run: |
          if [ "${{ steps.start.outcome }}" = "success" ]; then
            echo "Container pet-store #1 up and running" >> log.txt
            echo "Container pet-store #2 up and running" >> log.txt
            echo "Container pet-order up and running" >> log.txt
          else
            echo "Container pet-store #1 failed to run" >> log.txt
            echo "Container pet-store #2 failed to run" >> log.txt
            echo "Container pet-order failed to run" >> log.txt
          fi

      - run: |
          python -m pip install --upgrade pip
          pip install pytest requests

      - id: pytest
        continue-on-error: true
        run: pytest -v tests/assn4_tests.py | tee assn4_test_results.txt

      - run: |
          if [ "${{ steps.pytest.outcome }}" = "success" ]; then
            echo "All pytests succeeded" >> log.txt
          else
            echo "pytests failed" >> log.txt
          fi

      - if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-artifacts
          path: |
            log.txt
            assn4_test_results.txt

  query:
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: test-artifacts
          path: .

      - run: |
          python -m pip install --upgrade pip
          pip install requests

      - run: |
          docker build -t petstore:assn4 ./petstore
          docker build -t pet-order:assn4 ./pet-order

      - run: python query_job.py

      - uses: actions/upload-artifact@v4
        with:
          name: query-artifacts
          path: |
            response.txt
            log.txt
